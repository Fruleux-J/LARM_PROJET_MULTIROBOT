#!/usr/bin/python3
import rclpy
from rclpy.node import Node
from rclpy.context import Context
from std_msgs.msg import String
from random import random


class FactoryNode(Node):
    def __init__(self, domain_id: int, topic: str, freq: float, messages: list[str]):
        context = Context()
        context.init(domain_id=domain_id)

        super().__init__(f"multipub_{domain_id}", context=context)

        self._messages = messages
        self._index = 0

        self._publisher = self.create_publisher(String, topic, 10)
        self.create_timer(freq, self.publish_message)

    def publish_message(self):
        if self._index >= len(self._messages):
            return

        msg = String()
        msg.data = self._messages[self._index]
        self._publisher.publish(msg)

        self.get_logger().info(f"Sent: {msg.data}")
        self._index += 1


def generate_packages(nb_packages: int):
    packages = [[], []]  # 0 → pickup A, 1 → pickup B

    for i in range(nb_packages):
        pickup = 0 if random() <= 0.5 else 1
        r = random()

        if r <= 0.33:
            delivery = "A"
        elif r >= 0.66:
            delivery = "B"
        else:
            delivery = "C"

        packages[pickup].append((i, delivery))

    return packages


def build_messages(packages):
    coord_pickup = {
        "A": (1.7399678230285645, -0.4628455936908722, 0.0),
        "B": (1.6670589447021484, 0.6065198183059692, 0.0),
    }

    coord_delivery = {
        "A": (-5.3, 0.84, 0.0),
        "B": (-0.5, -2.15, 0.0),
        "C": (-4.6, -2.47, 0.0),
    }

    messages = []

    for pickup_index, colis_list in enumerate(packages):
        pickup_letter = "A" if pickup_index == 0 else "B"
        pickup_pos = coord_pickup[pickup_letter]

        for colis_id, delivery_letter in colis_list:
            delivery_pos = coord_delivery[delivery_letter]
            messages.append(
                f"{colis_id}, {pickup_pos}, {delivery_pos}"
            )

    return messages


def main():
    rclpy.init()

    packages = generate_packages(60)
    messages = build_messages(packages)

    nodes = [
        FactoryNode(28, "points", 3.0, messages),
        FactoryNode(44, "points", 3.0, messages),
    ]

    executor = rclpy.executors.MultiThreadedExecutor()
    for node in nodes:
        executor.add_node(node)

    try:
        executor.spin()
    finally:
        for node in nodes:
            node.destroy_node()
        rclpy.shutdown()


if __name__ == "__main__":
    main()
